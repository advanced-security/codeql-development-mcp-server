name: Release Tag - Create Version Tag

on:
  workflow_call:
    inputs:
      version:
        description: 'Release version (e.g., vX.Y.Z). Must start with "v".'
        required: true
        type: string
    outputs:
      release_name:
        description: 'The release name without "v" prefix (e.g., X.Y.Z)'
        value: ${{ jobs.create-tag.outputs.release_name }}
      tag_sha:
        description: 'The commit SHA that the tag points to'
        value: ${{ jobs.create-tag.outputs.tag_sha }}
      version:
        description: 'The full version string with "v" prefix (e.g., vX.Y.Z)'
        value: ${{ jobs.create-tag.outputs.version }}

# Note: This workflow is called exclusively via workflow_call from release.yml.
# It does NOT have a workflow_dispatch trigger to keep release.yml as the single
# entry point for all release operations.

permissions:
  contents: read

jobs:
  create-tag:
    name: Create Version Tag
    runs-on: ubuntu-latest

    environment: release-tag

    permissions:
      contents: write

    outputs:
      release_name: ${{ steps.version.outputs.release_name }}
      tag_sha: ${{ steps.final-sha.outputs.tag_sha }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Tag - Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.event.repository.default_branch }}

      - name: Tag - Validate and parse version
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          # Validate version starts with 'v'
          if [[ ! "${VERSION}" =~ ^v ]]; then
            echo "::error::Version '${VERSION}' must start with 'v'"
            exit 1
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_name=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Tag - Check if tag already exists
        id: check-tag
        run: |
          TAG="${{ steps.version.outputs.version }}"
          RELEASE_NAME="${{ steps.version.outputs.release_name }}"
          if git rev-parse "refs/tags/${TAG}" >/dev/null 2>&1; then
            TAG_SHA=$(git rev-parse "refs/tags/${TAG}^{commit}" 2>/dev/null || git rev-parse "refs/tags/${TAG}")
            echo "â„¹ï¸ Tag ${TAG} already exists at commit ${TAG_SHA:0:8}"

            # Verify version-bearing files at the tagged commit match the release
            TAG_SERVER_VERSION=$(git show "${TAG_SHA}:server/package.json" \
              | grep -m1 '"version"' \
              | sed 's/.*"version"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
            if [[ "${TAG_SERVER_VERSION}" == "${RELEASE_NAME}" ]]; then
              echo "tag_exists=true" >> $GITHUB_OUTPUT
              echo "tag_sha=${TAG_SHA}" >> $GITHUB_OUTPUT
              echo "âœ… Existing tag ${TAG} has correct version (${RELEASE_NAME})"
            else
              echo "âš ï¸ Version mismatch at tag ${TAG}: found ${TAG_SERVER_VERSION}, expected ${RELEASE_NAME}"
              echo "  Removing stale tag to recreate with correct versions..."
              git tag -d "${TAG}" 2>/dev/null || true
              git push origin ":refs/tags/${TAG}" 2>/dev/null || true
              echo "tag_exists=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Stale tag ${TAG} removed â€” will recreate with updated versions"
            fi
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Tag ${TAG} does not exist yet"
          fi

      - name: Tag - Validate versions at existing tag
        id: validate-tag
        if: steps.check-tag.outputs.tag_exists == 'true'
        run: |
          TAG="${{ steps.version.outputs.version }}"
          RELEASE_NAME="${{ steps.version.outputs.release_name }}"
          echo "Validating version consistency at existing tag ${TAG}..."

          # Check out the tagged commit to inspect version files
          git checkout "refs/tags/${TAG}"

          if ./server/scripts/update-release-version.sh --check "${RELEASE_NAME}"; then
            echo "tag_valid=true" >> $GITHUB_OUTPUT
            echo "âœ… Existing tag has correct versions"
          else
            echo "tag_valid=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸ Existing tag ${TAG} has incorrect versions."
            echo "Deleting tag and recreating with correct versions..."

            # Return to the original branch
            git checkout -

            # Delete the remote and local tag so it can be recreated
            git push --delete origin "${TAG}" || true
            git tag -d "${TAG}" || true

            echo "ðŸ—‘ï¸ Deleted tag ${TAG} â€” will recreate with correct versions"
          fi

      - name: Tag - Setup CodeQL environment
        if: steps.check-tag.outputs.tag_exists != 'true' || steps.validate-tag.outputs.tag_valid == 'false'
        uses: ./.github/actions/setup-codeql-environment
        with:
          add-to-path: true
          install-language-runtimes: false

      - name: Tag - Setup Node.js
        if: steps.check-tag.outputs.tag_exists != 'true' || steps.validate-tag.outputs.tag_valid == 'false'
        uses: actions/setup-node@v6
        with:
          cache: 'npm'
          node-version-file: '.node-version'

      - name: Tag - Update release version
        if: steps.check-tag.outputs.tag_exists != 'true' || steps.validate-tag.outputs.tag_valid == 'false'
        run: |
          TAG_VERSION="${{ steps.version.outputs.release_name }}"
          echo "Updating all version-bearing files to '${TAG_VERSION}'..."
          ./server/scripts/update-release-version.sh "${TAG_VERSION}"

      - name: Tag - Install dependencies
        if: steps.check-tag.outputs.tag_exists != 'true' || steps.validate-tag.outputs.tag_valid == 'false'
        run: npm install --include=optional

      - name: Tag - Install CodeQL pack dependencies
        if: steps.check-tag.outputs.tag_exists != 'true' || steps.validate-tag.outputs.tag_valid == 'false'
        run: server/scripts/install-packs.sh

      - name: Tag - Tidy (lint and format)
        if: steps.check-tag.outputs.tag_exists != 'true' || steps.validate-tag.outputs.tag_valid == 'false'
        run: npm run tidy

      - name: Tag - Build server
        if: steps.check-tag.outputs.tag_exists != 'true' || steps.validate-tag.outputs.tag_valid == 'false'
        run: npm run build -w server

      - name: Tag - Run tests
        if: steps.check-tag.outputs.tag_exists != 'true' || steps.validate-tag.outputs.tag_valid == 'false'
        run: npm run test:server

      - name: Tag - Commit version changes and create tag
        id: create-tag
        if: steps.check-tag.outputs.tag_exists != 'true' || steps.validate-tag.outputs.tag_valid == 'false'
        run: |
          TAG="${{ steps.version.outputs.version }}"
          RELEASE_NAME="${{ steps.version.outputs.release_name }}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Stage version-bearing files and lockfile changes
          git add -A
          # Ensure CodeQL-generated artifacts are not staged for commit
          git restore --staged .codeql || true
          git restore --staged '*.qlx' || true

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes to commit (versions already up to date)"
            CURRENT_SHA=$(git rev-parse HEAD)
          else
            git commit -m "Release ${TAG}: update versions to ${RELEASE_NAME}"
            CURRENT_SHA=$(git rev-parse HEAD)
            git push origin HEAD
            echo "âœ… Committed version changes at ${CURRENT_SHA:0:8}"
          fi

          # Create and push the tag
          git tag -a "${TAG}" -m "Release ${TAG}" "${CURRENT_SHA}"
          git push origin "${TAG}"
          echo "âœ… Created and pushed tag ${TAG} at commit ${CURRENT_SHA:0:8}"
          echo "tag_sha=${CURRENT_SHA}" >> $GITHUB_OUTPUT

      - name: Tag - Output existing tag SHA
        id: existing-tag
        if: steps.check-tag.outputs.tag_exists == 'true' && steps.validate-tag.outputs.tag_valid != 'false'
        run: |
          echo "tag_sha=${{ steps.check-tag.outputs.tag_sha }}" >> $GITHUB_OUTPUT

      - name: Tag - Set final tag SHA output
        id: final-sha
        run: |
          if [ "${{ steps.check-tag.outputs.tag_exists }}" == "true" ] && [ "${{ steps.validate-tag.outputs.tag_valid }}" != "false" ]; then
            SHA="${{ steps.check-tag.outputs.tag_sha }}"
          else
            SHA="${{ steps.create-tag.outputs.tag_sha }}"
          fi
          echo "tag_sha=${SHA}" >> $GITHUB_OUTPUT

      - name: Tag - Summary
        run: |
          TAG="${{ steps.version.outputs.version }}"
          echo "## Release Tag Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-tag.outputs.tag_exists }}" == "true" ] && [ "${{ steps.validate-tag.outputs.tag_valid }}" != "false" ]; then
            echo "â„¹ï¸ Tag \`${TAG}\` already existed at \`${{ steps.check-tag.outputs.tag_sha }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Created tag \`${TAG}\` at \`${{ steps.create-tag.outputs.tag_sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| ---- | ------ |" >> $GITHUB_STEP_SUMMARY
            echo "| Version update | âœ… All files updated to ${{ steps.version.outputs.release_name }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Tidy (lint + format) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            echo "| Build | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            echo "| Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            echo "| Tag creation | âœ… ${TAG} |" >> $GITHUB_STEP_SUMMARY
          fi
